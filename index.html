<!DOCTYPE html>
<html lang="ko" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JJTR-DEMO 계산기 v2</title>
  <style>
    :root{
      --bg:#f8f9fa; --fg:#212529; --muted:#6c757d; --card:#ffffff; --border:#dee2e6; --accent:#0d6efd; --accent-2:#5c7cfa; --warning:#e03131; --table-head:#f1f3f5; --shadow:0 4px 16px rgba(0,0,0,.06);
    }
    [data-theme="dark"]:root, @media (prefers-color-scheme:dark){
      --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa0a6; --card:#151821; --border:#2a2f3a; --accent:#4c8dff; --accent-2:#7b9dff; --warning:#ff6b6b; --table-head:#1a1f2b; --shadow:0 8px 24px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{margin:0; padding:16px; font-family:"Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg);}
    .container{max-width:980px; margin:0 auto;}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{margin:0; font-size:20px; font-weight:700}
    .toolbar{display:flex; gap:8px; align-items:center}
    .btn{appearance:none; border:1px solid var(--border); background:var(--card); color:var(--fg); padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px; box-shadow:var(--shadow);}
    .btn.primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:white; border:none}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
    .grid{display:grid; grid-template-columns:repeat(6,1fr); gap:12px}
    .grid .field{grid-column:span 3}
    @media (max-width:720px){ .grid{grid-template-columns:repeat(2,1fr)} .grid .field{grid-column:span 2} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 4px}
    input, select{width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--bg); color:var(--fg); font-size:14px}
    .section-title{margin:22px 0 8px; font-size:15px; font-weight:700; color:var(--muted)}
    table{width:100%; border-collapse:collapse; border-radius:12px; overflow:hidden; background:var(--card); box-shadow:var(--shadow)}
    th,td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:center; font-size:13px}
    thead th{background:var(--table-head); color:var(--fg);}
    .stop-loss{color:var(--warning); font-weight:700}
    .summary{display:flex; gap:16px; flex-wrap:wrap; margin-top:8px; color:var(--muted); font-size:13px}
    .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--bg); color:var(--fg)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>JJTR-DEMO 계산기 v2</h1>
      <div class="toolbar">
        <button class="btn" id="themeToggle">🌓</button>
      </div>
    </header>

    <div class="card">
      <div class="grid">
        <div class="field"><label>TR 입력</label><input type="number" id="tr" value="3.55" step="0.01"></div>
        <div class="field"><label>기준가</label><input type="number" id="basePrice" value="3360.55" step="0.01"></div>
        <div class="field"><label>총 자본금($)</label><input type="number" id="capital" value="25000" step="100"></div>
        <div class="field"><label>리스크(%)</label><input type="number" id="riskPercent" value="7" step="0.1"></div>
        <div class="field"><label>1 lot $1 움직임 손익($)</label><input type="number" id="dollarsPer1USDMove" value="100" step="1"></div>
        <div class="field">
          <label>구간 N</label>
          <select id="nPreset">
            <option value="both" selected>3.5 & 5.5 모두</option>
            <option value="3.5">3.5만</option>
            <option value="5.5">5.5만</option>
            <option value="custom">사용자 지정</option>
          </select>
        </div>
        <div class="field" id="customNWrap" style="display:none">
          <label>사용자 지정 N (예: 4.5)</label>
          <input type="number" id="customN" step="0.5" min="1" value="4.5">
        </div>
      </div>
      <button class="btn primary" id="calcBtn">계산하기</button>
    </div>

    <div id="tableWrap35" class="section" style="display:none">
      <div class="section-title">● 구간 1 ~ 손절가 (<span id="label35">3.5</span> TR)</div>
      <table id="zoneTable35"><thead><tr><th>구간</th><th>롱 진입가</th><th>숏 진입가</th><th>비중 (lot)</th></tr></thead><tbody></tbody></table>
      <div class="summary" id="summary35"></div>
    </div>

    <div id="tableWrap55" class="section" style="display:none">
      <div class="section-title">● 구간 1 ~ 손절가 (<span id="label55">5.5</span> TR)</div>
      <table id="zoneTable55"><thead><tr><th>구간</th><th>롱 진입가</th><th>숏 진입가</th><th>비중 (lot)</th></tr></thead><tbody></tbody></table>
      <div class="summary" id="summary55"></div>
    </div>
  </div>

  <script>
    const els={
      tr:document.getElementById('tr'),
      basePrice:document.getElementById('basePrice'),
      capital:document.getElementById('capital'),
      riskPercent:document.getElementById('riskPercent'),
      dollarsPer1USDMove:document.getElementById('dollarsPer1USDMove'),
      nPreset:document.getElementById('nPreset'),
      customNWrap:document.getElementById('customNWrap'),
      customN:document.getElementById('customN'),
      calcBtn:document.getElementById('calcBtn'),
      tableWrap35:document.getElementById('tableWrap35'),
      tableWrap55:document.getElementById('tableWrap55'),
      table35:document.querySelector('#zoneTable35 tbody'),
      table55:document.querySelector('#zoneTable55 tbody'),
      summary35:document.getElementById('summary35'),
      summary55:document.getElementById('summary55'),
      label35:document.getElementById('label35'),
      label55:document.getElementById('label55'),
      themeToggle:document.getElementById('themeToggle')
    };

    const fmt2=n=>Number(n).toFixed(2);

    // Theme toggle
    function getTheme(){return localStorage.getItem('jjtr_theme')||'auto';}
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t==='auto'? (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light') : t);
      localStorage.setItem('jjtr_theme', t);
    }
    els.themeToggle.addEventListener('click',()=>{
      const cur=getTheme();
      const next=cur==='light'?'dark':cur==='dark'?'auto':'light';
      applyTheme(next);
    });
    applyTheme(getTheme());

    // Preset UI
    els.nPreset.addEventListener('change',()=>{
      els.customNWrap.style.display = els.nPreset.value==='custom' ? '' : 'none';
    });

    function calculateZones(){
      const base=parseFloat(els.basePrice.value);
      const trv=parseFloat(els.tr.value);
      const cap=parseFloat(els.capital.value);
      const risk=parseFloat(els.riskPercent.value);
      const dpum=parseFloat(els.dollarsPer1USDMove.value);
      if([base,trv,cap,risk,dpum].some(v=>!isFinite(v)||v<=0)){
        alert('입력값을 확인해주세요. 모든 값은 양수여야 합니다.');
        return;
      }

      const totalLoss=(cap*risk)/100;

      // Determine which N values to render
      const choice=els.nPreset.value;
      const presets=[];
      if(choice==='both' || choice==='3.5') presets.push(3.5);
      if(choice==='both' || choice==='5.5') presets.push(5.5);
      if(choice==='custom') presets.push(parseFloat(els.customN.value));

      // reset views
      els.table35.innerHTML=''; els.table55.innerHTML='';
      els.summary35.innerHTML=''; els.summary55.innerHTML='';
      els.tableWrap35.style.display='none'; els.tableWrap55.style.display='none';

      function build(N){
        const rows=[]; const maxInt=Math.floor(N);
        for(let i=0;i<=maxInt;i++){ rows.push([`구간 ${i+1} (${i} TR)`, i, false]); }
        rows.push([`손절가 (${fmt2(N)} TR)`, N, true]);
        return rows;
      }

      function render(targetTbody, targetSummary, N){
        const rows=build(N);
        const active=rows.filter(r=>!r[2]);
        const perLoss=totalLoss/active.length;
        let sumLots=0;

        const stopLong = base - trv*N; // 손절가(롱)
        const zone1Long = base - trv*0; // 구간1(0TR) 롱 진입가 = 기준가
        const zoneDiff = Math.abs(stopLong - zone1Long); // 구간폭

        rows.forEach(([label,mult,isStop])=>{
          const longE = isStop ? stopLong : (base - trv*mult);
          const shortE = isStop ? (base + trv*N) : (base + trv*mult);

          let lots='';
          if(!isStop){
            const distance = trv*(N - mult); // $ from entry to stop
            const l = perLoss / (distance * dpum);
            sumLots += l;
            lots = fmt2(l);
          }

          const trEl=document.createElement('tr');
          trEl.innerHTML = `
            <td class="${isStop?'stop-loss':''}">${label}</td>
            <td class="${isStop?'stop-loss':''}">${fmt2(longE)}</td>
            <td class="${isStop?'stop-loss':''}">${fmt2(shortE)}</td>
            <td class="${isStop?'stop-loss':''}">${isStop? '' : lots}</td>
          `;
          targetTbody.appendChild(trEl);
        });

        targetSummary.innerHTML = `
          <span class="pill">총 허용손실: $${fmt2(totalLoss)}</span>
          <span class="pill">총 비중(합계): ${fmt2(sumLots)} lot</span>
          <span class="pill">구간폭: ${fmt2(zoneDiff)}</span>
        `;
      }

      presets.forEach(N=>{
        if(!isFinite(N) || N<=0) return;
        if(N===3.5){
          els.label35.textContent='3.5';
          els.tableWrap35.style.display='';
          render(els.table35, els.summary35, 3.5);
        } else if(N===5.5){
          els.label55.textContent='5.5';
          els.tableWrap55.style.display='';
          render(els.table55, els.summary55, 5.5);
        } else {
          // custom: 재사용 (tableWrap35에 렌더)
          els.label35.textContent=String(N);
          els.tableWrap35.style.display='';
          els.table35.innerHTML='';
          els.summary35.innerHTML='';
          render(els.table35, els.summary35, N);
        }
      });
    }

    document.getElementById('calcBtn').addEventListener('click', calculateZones);
    calculateZones();
  </script>
</body>
</html>
